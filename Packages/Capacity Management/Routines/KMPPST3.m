KMPPST3 ;SP/JML - VSM VERSION 2 POST INSTALL ROUTINE ;6/1/2020
 ;;4.0;CAPACITY MANAGEMENT;**1**;3/1/2018;Build 27
 ;
 ;
 N %DT,DA,DIC,DIE,DIK,DR,X,Y
 N KMPFDA,KMPGLO,KMPI,KMPMKEY,KMPTIEN,KMPVDATE,KMPVERR,KMPVERROR,KMPVMSG
 ;
 S X="T",%DT="ESTX" D ^%DT S KMPVDATE=Y
 ; stop current KMP monitors
 W !,"Stopping Monitors"
 D STOPALL^KMPVCBG
 ; REMOVE ANY LEGACY TASKMAN TASKS
 D RESCH^XUTMOPT("KMPV VBEM DATA TRANSMISSION","@",,,.KMPVERROR)
 D RESCH^XUTMOPT("KMPV VHLM DATA TRANSMISSION","@",,,.KMPVERROR)
 D RESCH^XUTMOPT("KMPV VMCM DATA TRANSMISSION","@",,,.KMPVERROR)
 D RESCH^XUTMOPT("KMPV VSTM DATA TRANSMISSION","@",,,.KMPVERROR)
 D RESCH^XUTMOPT("KMPV VTCM DATA TRANSMISSION","@",,,.KMPVERROR)
 ; Delete current KMP data
 W !,"Deleting Current Data"
 K ^KMPTMP("KMPV","VTCM")
 K ^KMPTMP("KMPV","VSTM")
 K ^KMPTMP("KMPV","VBEM")
 K ^KMPTMP("KMPV","VMCM")
 K ^KMPTMP("KMPV","VHLM")
 K ^KMPTMP("KMPV","VCSM")
 K ^KMPTMP("KMPV","VETM")
 ; Stop legacy coversheet collection
 S ^KMPTMP("KMPD-CPRS")=""
 D RESCH^XUTMOPT("KMPD BACKGROUND DRIVER","@",,,.KMPVERROR)
 K ^KMPTMP("KMPDT")
 ; Stop SAGG
 K ^XTMP("KMPS")
 S ^XTMP("KMPS","STOP")=1
 D RESCH^XUTMOPT("KMPS SAGG REPORT","@",,,.KMPVERROR)
 ; Disable legacy menu options
 D ENABLE^KMPTASK("KMPS",0)
 D ENABLE^KMPTASK("KMPD",0)
 ; delete existing legacy data
 F KMPGLO="^KMPR(8971.1)","^KMPD(8973.1)","^KMPD(8973.2)" D
 .S KMPI=""
 .F  S KMPI=$O(@KMPGLO@("")) Q:KMPI=""  D
 ..K @KMPGLO@(KMPI)
 ; Fix package name
 S DIC=9.4,DIC(0)="B",X="CAPCITY MANAGEMENT"
 D ^DIC
 S KMPTIEN=+Y
 I KMPTIEN>0 D
 .S DIE=9.4,DA=KMPTIEN,DR=".01///CAPACITY MANAGEMENT" D ^DIE
 ;
 D MONCFG
 D MAKE^KMPPST3A
 W !,"Data collection will start at midnight."
 W !,"Monitors will not start automatically in TEST systems."
 W !,"   Set 'ALLOW TEST' to YES and start manually if desired."
 ; Set endpoint based on Prod/Test
 N DA,DIE,DR,KMPIEN,KMPPROD
 S KMPPROD=$$PROD^KMPVCCFG
 I KMPPROD="Prod" D
 .F KMPIEN=1,2,3,4,5,6,7 D
 ..S DIE=8969,DA=KMPIEN,DR="4.02///prod.vsm.cpe.domain.ext" D ^DIE
 I KMPPROD'="Prod" D
 .F KMPIEN=1,2,3,4,5,6,7 D
 ..S DIE=8969,DA=KMPIEN,DR="4.02///test.vsm.cpe.domain.ext" D ^DIE
 ; Send config message to nat'l server
 D CFGMSG^KMPUTLW
 Q
 ;
MONCFG ;
 ; delete all existing entries in configuraton files
 S DA=0
 F  S DA=$O(^KMPV(8969,DA)) Q:+DA=0  D
 .S DIK="^KMPV(8969," D ^DIK
 K ^KMPV(8969,"B")
 S DA=0
 F  S DA=$O(^KMPV(8969.02,DA)) Q:+DA=0  D
 .S DIK="^KMPV(8969.02," D ^DIK
 K ^KMPV(8969.02,"B")
 ;
 ; reset all entries
 ; 1: VTCM
 K KMPFDA,KMPVERR
 S KMPFDA($J,8969,"+1,",.01)="VTCM"
 S KMPFDA($J,8969,"+1,",.02)=0
 S KMPFDA($J,8969,"+1,",.03)="VISTA TIMED COLLECTION MONITOR"
 S KMPFDA($J,8969,"+1,",.04)=3
 S KMPFDA($J,8969,"+1,",.05)=KMPVDATE
 S KMPFDA($J,8969,"+1,",1.01)=7
 S KMPFDA($J,8969,"+1,",1.02)=5
 S KMPFDA($J,8969,"+1,",1.03)="KMPTCMRT"
 S KMPFDA($J,8969,"+1,",1.04)=0
 S KMPFDA($J,8969,"+1,",1.05)="1D"
 S KMPFDA($J,8969,"+1,",1.06)="T+1@01"
 S KMPFDA($J,8969,"+1,",1.07)="KMPV VTCM DATA RETRANSMISSION"
 S KMPFDA($J,8969,"+1,",1.08)=1
 S KMPFDA($J,8969,"+1,",1.09)=0
 S KMPFDA($J,8969,"+1,",3.01)="S.KMPV-VTCM-SERVER@VISTA.CPE.DOMAIN.EXT"
 S KMPFDA($J,8969,"+1,",3.02)="CPEVSM@DOMAIN.EXT"
 S KMPFDA($J,8969,"+1,",3.03)="S.KMPV-VSM-SERVER@VISTA.CPE.DOMAIN.EXT"
 ; 2: VSTM
 S KMPFDA($J,8969,"+2,",.01)="VSTM"
 S KMPFDA($J,8969,"+2,",.02)=0
 S KMPFDA($J,8969,"+2,",.03)="VISTA STORAGE MONITOR"
 S KMPFDA($J,8969,"+2,",.04)=3
 S KMPFDA($J,8969,"+2,",.05)=KMPVDATE
 S KMPFDA($J,8969,"+2,",1.01)=7
 S KMPFDA($J,8969,"+2,",1.02)=5
 S KMPFDA($J,8969,"+2,",1.03)="KMPSTMRT"
 S KMPFDA($J,8969,"+2,",1.04)=0
 S KMPFDA($J,8969,"+2,",1.05)="1D"
 S KMPFDA($J,8969,"+2,",1.06)="T+1@01"
 S KMPFDA($J,8969,"+2,",1.07)="KMPV VSTM DATA RETRANSMISSION"
 S KMPFDA($J,8969,"+2,",1.08)=1
 S KMPFDA($J,8969,"+2,",1.09)=0
 S KMPFDA($J,8969,"+2,",3.01)="S.KMPV-VSTM-SERVER@VISTA.CPE.DOMAIN.EXT"
 S KMPFDA($J,8969,"+2,",3.02)="CPEVSM@DOMAIN.EXT"
 S KMPFDA($J,8969,"+2,",3.03)="S.KMPV-VSM-SERVER@VISTA.CPE.DOMAIN.EXT"
 ; 3: VBEM
 S KMPFDA($J,8969,"+3,",.01)="VBEM"
 S KMPFDA($J,8969,"+3,",.02)=0
 S KMPFDA($J,8969,"+3,",.03)="VISTA BUSINESS EVENT MONITOR"
 S KMPFDA($J,8969,"+3,",.04)=3
 S KMPFDA($J,8969,"+3,",.05)=KMPVDATE
 S KMPFDA($J,8969,"+3,",1.01)=7
 S KMPFDA($J,8969,"+3,",1.02)=5
 S KMPFDA($J,8969,"+3,",1.03)="KMPBEMRT"
 S KMPFDA($J,8969,"+3,",1.04)=0
 S KMPFDA($J,8969,"+3,",1.05)="1D"
 S KMPFDA($J,8969,"+3,",1.06)="T+1@01"
 S KMPFDA($J,8969,"+3,",1.07)="KMPV VBEM DATA RETRANSMISSION"
 S KMPFDA($J,8969,"+3,",1.08)=1
 S KMPFDA($J,8969,"+3,",1.09)=0
 S KMPFDA($J,8969,"+3,",3.01)="S.KMPV-VBEM-SERVER@VISTA.CPE.DOMAIN.EXT"
 S KMPFDA($J,8969,"+3,",3.02)="CPEVSM@DOMAIN.EXT"
 S KMPFDA($J,8969,"+3,",3.03)="S.KMPV-VSM-SERVER@VISTA.CPE.DOMAIN.EXT"
 ; 4: VMCM
 S KMPFDA($J,8969,"+4,",.01)="VMCM"
 S KMPFDA($J,8969,"+4,",.02)=0
 S KMPFDA($J,8969,"+4,",.03)="VISTA MESSAGE COUNT MONITOR"
 S KMPFDA($J,8969,"+4,",.04)=3
 S KMPFDA($J,8969,"+4,",.05)=KMPVDATE
 S KMPFDA($J,8969,"+4,",1.01)=7
 S KMPFDA($J,8969,"+4,",1.02)=15
 S KMPFDA($J,8969,"+4,",1.03)="KMPMCMRT"
 S KMPFDA($J,8969,"+4,",1.04)=0
 S KMPFDA($J,8969,"+4,",1.05)="1D"
 S KMPFDA($J,8969,"+4,",1.06)="T+1@0130"
 S KMPFDA($J,8969,"+4,",1.07)="KMPV VMCM DATA RETRANSMISSION"
 S KMPFDA($J,8969,"+4,",1.08)=1
 S KMPFDA($J,8969,"+4,",1.09)=0
 S KMPFDA($J,8969,"+4,",3.01)="S.KMPV-VMCM-SERVER@VISTA.CPE.DOMAIN.EXT"
 S KMPFDA($J,8969,"+4,",3.02)="CPEVSM@DOMAIN.EXT"
 S KMPFDA($J,8969,"+4,",3.03)="S.KMPV-VSM-SERVER@VISTA.CPE.DOMAIN.EXT"
 ; 5: VHLM
 S KMPFDA($J,8969,"+5,",.01)="VHLM"
 S KMPFDA($J,8969,"+5,",.02)=0
 S KMPFDA($J,8969,"+5,",.03)="VISTA HL7 MONITOR"
 S KMPFDA($J,8969,"+5,",.04)=3
 S KMPFDA($J,8969,"+5,",.05)=KMPVDATE
 S KMPFDA($J,8969,"+5,",1.01)=3
 S KMPFDA($J,8969,"+5,",1.02)=5
 S KMPFDA($J,8969,"+5,",1.03)="KMPHLMRT"
 S KMPFDA($J,8969,"+5,",1.04)=0
 S KMPFDA($J,8969,"+5,",1.05)="1D"
 S KMPFDA($J,8969,"+5,",1.06)="T+1@02"
 S KMPFDA($J,8969,"+5,",1.07)="KMPV VHLM DATA RETRANSMISSION"
 S KMPFDA($J,8969,"+5,",1.08)=1
 S KMPFDA($J,8969,"+5,",1.09)=0
 S KMPFDA($J,8969,"+5,",3.01)="S.KMPV-VHLM-SERVER@VISTA.CPE.DOMAIN.EXT"
 S KMPFDA($J,8969,"+5,",3.02)="CPEVSM@DOMAIN.EXT"
 S KMPFDA($J,8969,"+5,",3.03)="S.KMPV-VSM-SERVER@VISTA.CPE.DOMAIN.EXT"
 ; 6: VCSM
 S KMPFDA($J,8969,"+6,",.01)="VCSM"
 S KMPFDA($J,8969,"+6,",.02)=0
 S KMPFDA($J,8969,"+6,",.03)="VISTA COVERSHEET TIMING MONITOR"
 S KMPFDA($J,8969,"+6,",.04)=3
 S KMPFDA($J,8969,"+6,",.05)=KMPVDATE
 S KMPFDA($J,8969,"+6,",1.01)=7
 S KMPFDA($J,8969,"+6,",1.02)=5
 S KMPFDA($J,8969,"+6,",1.03)="KMPCSMRT"
 S KMPFDA($J,8969,"+6,",1.04)=0
 S KMPFDA($J,8969,"+6,",1.05)="1D"
 S KMPFDA($J,8969,"+6,",1.06)="T+1@02"
 S KMPFDA($J,8969,"+6,",1.07)="KMPV VCSM DATA RETRANSMISSION"
 S KMPFDA($J,8969,"+6,",1.08)=1
 S KMPFDA($J,8969,"+6,",1.09)=0
 S KMPFDA($J,8969,"+6,",3.01)=""
 S KMPFDA($J,8969,"+6,",3.02)="CPEVSM@DOMAIN.EXT"
 S KMPFDA($J,8969,"+6,",3.03)="S.KMPV-VSM-SERVER@VISTA.CPE.DOMAIN.EXT"
 ; 7: VETM
 S KMPFDA($J,8969,"+7,",.01)="VETM"
 S KMPFDA($J,8969,"+7,",.02)=0
 S KMPFDA($J,8969,"+7,",.03)="VISTA ERROR TRAP MONITOR"
 S KMPFDA($J,8969,"+7,",.04)=3
 S KMPFDA($J,8969,"+7,",.05)=KMPVDATE
 S KMPFDA($J,8969,"+7,",1.01)=7
 S KMPFDA($J,8969,"+7,",1.02)=5
 S KMPFDA($J,8969,"+7,",1.03)="KMPETMRT"
 S KMPFDA($J,8969,"+7,",1.04)=0
 S KMPFDA($J,8969,"+7,",1.05)="1D"
 S KMPFDA($J,8969,"+7,",1.06)="T+1@02"
 S KMPFDA($J,8969,"+7,",1.07)="KMPV VETM DATA RETRANSMISSION"
 S KMPFDA($J,8969,"+7,",1.08)=1
 S KMPFDA($J,8969,"+7,",1.09)=0
 S KMPFDA($J,8969,"+7,",3.01)=""
 S KMPFDA($J,8969,"+7,",3.02)="CPEVSM@DOMAIN.EXT"
 S KMPFDA($J,8969,"+7,",3.03)="S.KMPV-VSM-SERVER@VISTA.CPE.DOMAIN.EXT"
 ;
 D UPDATE^DIE("","KMPFDA($J)","ZIEN","KMPVERR")
 I $D(KMPVERR) D
 .W !!,"*** THERE WAS AN ERROR IN UPDATING THE 'VSM CONFIGURATION' FILE! ***"
 .S KMPVMSG(1)="There was an error in updating the 'VSM CONFIGURATION' file!"
 .S KMPVMSG(2)="Please send email to 'VA IT EPMO CPE Engineers' via Outlook."
 .D MES^XPDUTL(.KMPVMSG)
 Q

ISIIMP15 ;ISI GROUP/MLS -- NOTES IMPORT CONT.
 ;;1.0;;;Jun 26,2012;Build 93
 Q
 ;
VALIDATE()      ;
 ; Validate import array contents
 S ISIRC=$$VALNOTE^ISIIMPU8(.ISIMISC)
 Q ISIRC
 ;
MAKENOTE() ;
 ; Create patient(s)
 S ISIRC=$$IMPRTNOT(.ISIMISC)
 Q ISIRC
 ;
IMPRTNOT(ISIMISC) ;Create Progress Note entry
 ; Input - ISIMISC(ARRAY)
 ; Format:  ISIMISC(PARAM)=VALUE
 ;     eg:  ISIMISC("DFN")=12345 
 ;
 ; Output - ISIRC [return code]
 ;          ISIRESUL(0)=1 [if successful]
 ;          ISIRESUL(1)=TIUDA [if successful] 
 ;
 N DFN,VDT,ARRAY,SUPPRESS,NOASF,RESULT,VLOC,TIUDA,TITLE,TEXT,SIGN,VSTR,PROV
 S ISIRC=1,RESULT=""
 D PREP
 I +ISIRC<0 Q ISIRC
 D MAKETIU
 I +ISIRC<0 Q ISIRC
 D INSTXT
 I +ISIRC<0 Q ISIRC
 D SIGN
 I +ISIRC<0 Q ISIRC
 S ISIRESUL(0)=1,ISIRESUL(1)=$G(TIUDA)
 Q 1
 ;
PREP
 S DFN=$G(ISIMISC("DFN"))
 S TITLE=$G(ISIMISC("TIU"))
 S VLOC=$G(ISIMISC("VLOC"))
 S PROV=$G(ISIMISC("PROV"))
 S VDT=$G(ISIMISC("VDT"))
 S TEXT=$G(ISIMISC("TEXT"))
 K ARRAY
 S ARRAY(1202)=PROV
 S ARRAY(1301)=VDT
 S ARRAY(1205)=VLOC
 S VSTR=ISIMISC("VISIT")
 S SUPPRESS=0
 S NOASF=""
 S SIGN=$G(ISIMISC("ES"))
 S ISIRC=$S(DFN="":-1,TITLE="":-1,VLOC="":-1,PROV="":-1,VDT="":-1,VSTR="":-1,SIGN="":-1,1:1)
 I ISIRC=-1 S ISIRC="-1^Validation error (PREP ISIIMP15)" Q
 Q
 ;
MAKETIU
 D MAKE^TIUSRVP(.RESULT,DFN,TITLE,VDT,VLOC,"",.ARRAY,VSTR,SUPPRESS,NOASF)
 I +RESULT<1 S ISIRC="-1^Unable to create note" Q
 S TIUDA=RESULT
 Q
 ;
INSTXT
 K ARRAY
 S ARRAY("TEXT",1,0)=TEXT
 S ARRAY("HDR")="1^1"
 D SETTEXT^TIUSRVPT(.RESULT,TIUDA,.ARRAY,0)
 I +RESULT<1 S ISIRC="-1^Unable to insert text into note" Q
 Q
 ;
SIGN
 N ES
 S ES=$$ENCRYP^XUSRB1(SIGN)
 D SIGN^TIUSRVP2(.RESULT,TIUDA,ES)
 I +RESULT<0 S ISIRC="-1^Unable to electronically sign note" Q
 Q
